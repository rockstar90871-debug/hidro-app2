<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Simulador Indoor Hidropon√≠a</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f1f17;
  color: #eaffea;
  text-align: center;
  padding: 20px;
}

.baldes {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  max-width: 480px;
  margin: auto;
}

.balde {
  padding: 15px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  color: white;
}

.estado-ok { background: #2d6a4f; }
.estado-at { background: #b08900; }
.estado-mal { background: #9b2226; }

.panel {
  background: #1b4332;
  padding: 20px;
  max-width: 600px;
  margin: 20px auto;
  border-radius: 12px;
}

.oculto { display: none; }

label {
  display: block;
  margin-top: 10px;
  text-align: left;
}

input, textarea {
  width: 100%;
  padding: 6px;
  border-radius: 5px;
  border: none;
}

textarea {
  resize: vertical;
}

button {
  margin-top: 10px;
  padding: 10px;
  width: 100%;
  background: #52b788;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  cursor: pointer;
}

button.borrar {
  background: #9b2226;
}

table {
  width: 100%;
  margin-top: 15px;
  border-collapse: collapse;
  font-size: 12px;
}

th, td {
  border: 1px solid #40916c;
  padding: 4px;
}

#mensajeEstado {
  margin-top: 12px;
  padding: 10px;
  border-radius: 8px;
  background: rgba(0,0,0,0.25);
  text-align: left;
  font-size: 14px;
}
</style>
</head>

<body>

<h1>üå± Simulador Indoor Hidropon√≠a</h1>

<div class="baldes" id="baldes"></div>

<div id="panel" class="panel oculto">
  <h2 id="tituloBalde"></h2>
  <div id="mensajeEstado"></div>

  <label>Gen√©tica</label>
  <input type="text" id="genetica">

  <form id="registroForm">
    <label>Semana</label>
    <input type="week" id="semana" required>

    <label>pH</label>
    <input type="number" step="0.1" id="ph">

    <label>EC</label>
    <input type="number" step="0.1" id="ec">

    <label>Grow</label>
    <input type="number" step="0.1" id="grow">

    <label>Micro</label>
    <input type="number" step="0.1" id="micro">

    <label>Bloom</label>
    <input type="number" step="0.1" id="bloom">

    <button>üíæ Guardar registro semanal</button>
  </form>

  <button id="descargarSeguimiento">‚¨áÔ∏è Descargar seguimiento semanal (Word)</button>

  <label>üìù Observaciones finales del ciclo</label>
  <textarea id="observaciones" rows="4"
    placeholder="Ej: comportamiento de la gen√©tica, rendimiento, problemas, soluciones aplicadas..."></textarea>

  <button id="descargarResumen">üìÑ Descargar resumen final del ciclo</button>

  <button id="borrarHistorial" class="borrar">üóëÔ∏è Cerrar ciclo (borrar historial)</button>

  <div id="historial"></div>
</div>

<script>
const baldesDiv = document.getElementById("baldes");
const panel = document.getElementById("panel");
const tituloBalde = document.getElementById("tituloBalde");
const mensajeEstado = document.getElementById("mensajeEstado");
const genetica = document.getElementById("genetica");
const registroForm = document.getElementById("registroForm");
const semana = document.getElementById("semana");
const ph = document.getElementById("ph");
const ec = document.getElementById("ec");
const grow = document.getElementById("grow");
const micro = document.getElementById("micro");
const bloom = document.getElementById("bloom");
const historial = document.getElementById("historial");
const observaciones = document.getElementById("observaciones");

let baldeActual = null;

/* ===== BALDES ===== */
for (let i = 1; i <= 9; i++) {
  const b = document.createElement("button");
  b.className = "balde estado-ok";
  b.onclick = () => abrirBalde(i);
  b.id = `balde${i}`;
  baldesDiv.appendChild(b);
  actualizarBalde(i);
}

function iconoEstado(e) {
  return e === "ok" ? "üü¢ OK" : e === "at" ? "üü° ATENCI√ìN" : "üî¥ ALERTA";
}

function estadoRegistro(ph, ec) {
  if (ph < 5.5 || ph > 6.5 || ec < 1 || ec > 2.5) return "mal";
  if (ph < 5.7 || ph > 6.3) return "at";
  return "ok";
}

function actualizarBalde(n) {
  const g = localStorage.getItem(`balde${n}_genetica`) || "Sin gen√©tica";
  const e = localStorage.getItem(`balde${n}_estado`) || "ok";
  const b = document.getElementById(`balde${n}`);
  b.className = `balde estado-${e}`;
  b.innerHTML = `ü™£ Balde ${n}<br><small>${g}</small>`;
}

function abrirBalde(n) {
  baldeActual = n;
  panel.classList.remove("oculto");
  genetica.value = localStorage.getItem(`balde${n}_genetica`) || "";
  observaciones.value = localStorage.getItem(`balde${n}_obs`) || "";
  tituloBalde.innerText = `Balde ${n} ‚Äì ${genetica.value || "Sin gen√©tica"}`;
  cargarHistorial();
}

genetica.onchange = () => {
  localStorage.setItem(`balde${baldeActual}_genetica`, genetica.value);
  actualizarBalde(baldeActual);
};

/* ===== GUARDAR REGISTRO ===== */
registroForm.onsubmit = e => {
  e.preventDefault();
  if (!ph.value || !ec.value) return alert("Ingresar pH y EC");

  const est = estadoRegistro(ph.value, ec.value);

  localStorage.setItem(`balde${baldeActual}_${semana.value}`, JSON.stringify({
    semana: semana.value, ph: ph.value, ec: ec.value,
    grow: grow.value, micro: micro.value, bloom: bloom.value,
    estado: est
  }));

  localStorage.setItem(`balde${baldeActual}_estado`, est);
  cargarHistorial();
  actualizarBalde(baldeActual);
  registroForm.reset();
};

/* ===== HISTORIAL ===== */
function cargarHistorial() {
  const keys = Object.keys(localStorage)
    .filter(k => k.startsWith(`balde${baldeActual}_`) && k.includes("W"))
    .sort();

  let html = "<table><tr><th>Semana</th><th>pH</th><th>EC</th><th>Estado</th></tr>";
  let ultimo = null;

  keys.forEach(k => {
    const d = JSON.parse(localStorage[k]);
    ultimo = d;
    html += `<tr><td>${d.semana}</td><td>${d.ph}</td><td>${d.ec}</td><td>${iconoEstado(d.estado)}</td></tr>`;
  });

  historial.innerHTML = html + "</table>";
  mensajeEstado.innerHTML = ultimo ? `<strong>Estado actual:</strong> ${iconoEstado(ultimo.estado)}` : "";
}

/* ===== DESCARGAS WORD ===== */
function descargarWord(nombre, contenido) {
  const blob = new Blob(['\ufeff', contenido], { type: "application/msword" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = nombre;
  a.click();
}

/* ===== SEGUIMIENTO ===== */
document.getElementById("descargarSeguimiento").onclick = () => generarDocumento(false);

/* ===== RESUMEN FINAL ===== */
document.getElementById("descargarResumen").onclick = () => generarDocumento(true);

function generarDocumento(resumenFinal) {
  const keys = Object.keys(localStorage)
    .filter(k => k.startsWith(`balde${baldeActual}_`) && k.includes("W"))
    .sort();

  if (!keys.length) return alert("No hay registros");

  let phs = 0, ecs = 0;
  let filas = "";

  keys.forEach(k => {
    const d = JSON.parse(localStorage[k]);
    phs += parseFloat(d.ph);
    ecs += parseFloat(d.ec);
    filas += `<tr>
      <td>${d.semana}</td><td>${d.ph}</td><td>${d.ec}</td>
      <td>${d.grow}</td><td>${d.micro}</td><td>${d.bloom}</td>
      <td>${iconoEstado(d.estado)}</td>
    </tr>`;
  });

  const promPH = (phs / keys.length).toFixed(2);
  const promEC = (ecs / keys.length).toFixed(2);

  const html = `
  <html><body>
  <h1>${resumenFinal ? "Resumen final del ciclo" : "Seguimiento semanal"}</h1>
  <p><strong>Balde:</strong> ${baldeActual}</p>
  <p><strong>Gen√©tica:</strong> ${genetica.value}</p>
  ${resumenFinal ? `
    <p><strong>Semanas:</strong> ${keys.length}</p>
    <p><strong>pH promedio:</strong> ${promPH}</p>
    <p><strong>EC promedio:</strong> ${promEC}</p>
    <p><strong>Observaciones finales:</strong><br>${observaciones.value}</p>
  ` : ""}
  <table border="1" cellspacing="0" cellpadding="4">
    <tr>
      <th>Semana</th><th>pH</th><th>EC</th>
      <th>Grow</th><th>Micro</th><th>Bloom</th><th>Estado</th>
    </tr>
    ${filas}
  </table>
  </body></html>
  `;

  descargarWord(
    resumenFinal
      ? `balde_${baldeActual}_resumen_final.doc`
      : `balde_${baldeActual}_seguimiento_semanal.doc`,
    html
  );
}

/* ===== CIERRE DE CICLO ===== */
document.getElementById("borrarHistorial").onclick = () => {
  if (!confirm("¬øCerrar ciclo y borrar datos?")) return;
  Object.keys(localStorage)
    .filter(k => k.startsWith(`balde${baldeActual}_`))
    .forEach(k => localStorage.removeItem(k));
  historial.innerHTML = "";
  mensajeEstado.innerHTML = "";
  actualizarBalde(baldeActual);
};
</script>

</body>
</html>
