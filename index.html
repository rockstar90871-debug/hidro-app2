<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Simulador Indoor Hidropon√≠a</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f1f17;
  color: #eaffea;
  margin: 0;
  padding: 15px;
}

h1 { text-align:center; }

.baldes {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  max-width: 500px;
  margin: auto;
}

.balde {
  padding: 15px;
  border-radius: 12px;
  border: none;
  color: white;
  cursor: pointer;
  background-size: cover;
  background-position: center;
  position: relative;
}

.balde::after {
  content:"";
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.45);
  border-radius:12px;
}

.balde span {
  position: relative;
  z-index:2;
}

.estado-ok { background:#2d6a4f; }
.estado-at { background:#b08900; }
.estado-mal { background:#9b2226; }

.panel {
  max-width: 650px;
  margin: 20px auto;
  background:#1b4332;
  border-radius:14px;
  padding:15px;
  background-size: cover;
  background-position: center;
}

.oculto { display:none; }

.card {
  background:rgba(0,0,0,.25);
  padding:12px;
  border-radius:10px;
  margin-top:12px;
}

label { display:block; margin-top:8px; text-align:left; }

input, select, textarea {
  width:100%;
  padding:6px;
  border-radius:6px;
  border:none;
}

button {
  margin-top:10px;
  padding:10px;
  border:none;
  border-radius:8px;
  background:#52b788;
  cursor:pointer;
}

button.borrar { background:#9b2226; }

table {
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}

th, td {
  border:1px solid #40916c;
  padding:4px;
}

.galeria {
  display:flex;
  gap:8px;
  overflow-x:auto;
}

.galeria img {
  height:80px;
  border-radius:8px;
}
</style>
</head>

<body>

<h1>üå± Simulador Indoor Hidropon√≠a</h1>

<div class="baldes" id="baldes"></div>

<div id="panel" class="panel oculto">
  <h2 id="tituloBalde"></h2>

  <div class="card" id="mensajeEstado"></div>

  <div class="card">
    <label>Gen√©tica</label>
    <input id="genetica">

    <label>Etapa de la planta</label>
    <select id="etapa">
      <option>Germinaci√≥n</option>
      <option>Vegetativo</option>
      <option>Floraci√≥n</option>
      <option>Lavado</option>
    </select>

    <label>üì∏ Foto semanal</label>
    <input type="file" id="fotoSemana" accept="image/*" capture="environment">
  </div>

  <div class="card">
    <form id="registroForm">
      <label>Semana</label>
      <input type="week" id="semana" required>

      <label>pH</label>
      <input type="number" step="0.1" id="ph">

      <label>EC</label>
      <input type="number" step="0.1" id="ec">

      <label>Notas semanales</label>
      <textarea id="nota"></textarea>

      <button>üíæ Guardar semana</button>
    </form>
  </div>

  <div class="card">
    <h3>üì∏ Galer√≠a semanal</h3>
    <div class="galeria" id="galeria"></div>
  </div>

  <div class="card" id="historial"></div>

  <button class="borrar" id="borrarHistorial">üóëÔ∏è Cerrar ciclo</button>
</div>

<script>
const baldesDiv = document.getElementById("baldes");
const panel = document.getElementById("panel");
const tituloBalde = document.getElementById("tituloBalde");
const mensajeEstado = document.getElementById("mensajeEstado");
const genetica = document.getElementById("genetica");
const etapa = document.getElementById("etapa");
const semana = document.getElementById("semana");
const ph = document.getElementById("ph");
const ec = document.getElementById("ec");
const nota = document.getElementById("nota");
const fotoSemana = document.getElementById("fotoSemana");
const galeria = document.getElementById("galeria");
const historial = document.getElementById("historial");

let baldeActual = null;

/* ==== BALDES ==== */
for(let i=1;i<=9;i++){
  const b=document.createElement("button");
  b.id=`balde${i}`;
  b.onclick=()=>abrirBalde(i);
  baldesDiv.appendChild(b);
  actualizarBalde(i);
}

function iconoEstado(e){
  return e==="ok"?"üü¢ OK":e==="at"?"üü° ATENCI√ìN":"üî¥ ALERTA";
}

function evaluarEstado(ph,ec){
  let estado="ok",msgs=[];
  if(ph<5.5||ph>6.5){estado="mal";msgs.push("pH cr√≠tico");}
  if(ec<1){estado="at";msgs.push("EC baja");}
  if(ec>2.5){estado="mal";msgs.push("EC alta");}
  if(!msgs.length)msgs.push("Par√°metros √≥ptimos");
  return{estado,msgs};
}

function actualizarBalde(n){
  const g=localStorage.getItem(`balde${n}_gen`)||"Sin gen√©tica";
  const e=localStorage.getItem(`balde${n}_estado`)||"ok";
  const b=document.getElementById(`balde${n}`);
  b.className=`balde estado-${e}`;
  b.innerHTML=`<span>ü™£ ${n}<br><small>${g}</small></span>`;
}

function abrirBalde(n){
  baldeActual=n;
  panel.classList.remove("oculto");
  genetica.value=localStorage.getItem(`balde${n}_gen`)||"";
  etapa.value=localStorage.getItem(`balde${n}_etapa`)||"Vegetativo";
  tituloBalde.innerText=`Balde ${n}`;
  cargarHistorial();
  cargarGaleria();
}

genetica.onchange=()=>localStorage.setItem(`balde${baldeActual}_gen`,genetica.value);
etapa.onchange=()=>localStorage.setItem(`balde${baldeActual}_etapa`,etapa.value);

registroForm.onsubmit=e=>{
  e.preventDefault();
  const ev=evaluarEstado(ph.value,ec.value);
  localStorage.setItem(`balde${baldeActual}_${semana.value}`,JSON.stringify({
    semana:semana.value,ph:ph.value,ec:ec.value,
    nota:nota.value,estado:ev.estado,msgs:ev.msgs
  }));
  localStorage.setItem(`balde${baldeActual}_estado`,ev.estado);
  if(fotoSemana.files[0]){
    const r=new FileReader();
    r.onload=()=>localStorage.setItem(`balde${baldeActual}_foto_${semana.value}`,r.result);
    r.readAsDataURL(fotoSemana.files[0]);
  }
  registroForm.reset();
  cargarHistorial();
  cargarGaleria();
  actualizarBalde(baldeActual);
};

function cargarHistorial(){
  const keys=Object.keys(localStorage).filter(k=>k.startsWith(`balde${baldeActual}_W`)).sort();
  let html="<table><tr><th>Semana</th><th>pH</th><th>EC</th><th>Estado</th></tr>";
  let alertas=0;
  keys.forEach(k=>{
    const d=JSON.parse(localStorage[k]);
    if(d.estado!=="ok")alertas++;
    html+=`<tr><td>${d.semana}</td><td>${d.ph}</td><td>${d.ec}</td><td>${iconoEstado(d.estado)}</td></tr>`;
  });
  historial.innerHTML=html+"</table>";
  mensajeEstado.innerHTML=alertas>=2
    ?"‚ö†Ô∏è Varias semanas con problemas. Revisar manejo."
    :"Estado controlado.";
}

function cargarGaleria(){
  galeria.innerHTML="";
  Object.keys(localStorage)
    .filter(k=>k.startsWith(`balde${baldeActual}_foto_`))
    .forEach(k=>{
      const img=document.createElement("img");
      img.src=localStorage[k];
      galeria.appendChild(img);
    });
}

document.getElementById("borrarHistorial").onclick=()=>{
  if(!confirm("Cerrar ciclo?"))return;
  Object.keys(localStorage)
    .filter(k=>k.startsWith(`balde${baldeActual}_`))
    .forEach(k=>localStorage.removeItem(k));
  panel.classList.add("oculto");
  actualizarBalde(baldeActual);
};
</script>

</body>
</html>

