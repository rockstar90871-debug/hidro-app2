<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sala de Cultivo Inteligente</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1b4332">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f1f17;
  color: #eaffea;
  text-align: center;
  padding: 20px;
  margin: 0;
}

h1 {
  margin-top: 10px;
}

.baldes {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  max-width: 480px;
  margin: auto;
}

.balde {
  padding: 15px;
  border-radius: 12px;
  cursor: pointer;
  color: white;
  background-size: cover;
  background-position: center;
  position: relative;
  min-height: 90px;
}

.balde::after {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.45);
  border-radius: 12px;
}

.balde span {
  position: relative;
  z-index: 2;
  font-size: 14px;
}

.estado-ok { background-color: #2d6a4f; }
.estado-at { background-color: #b08900; }
.estado-mal { background-color: #9b2226; }

.panel {
  background: #1b4332;
  padding: 20px;
  max-width: 650px;
  margin: 20px auto;
  border-radius: 15px;
}

.oculto { display: none; }

label {
  display: block;
  margin-top: 10px;
  text-align: left;
  font-size: 13px;
}

input, select, textarea {
  width: 100%;
  padding: 7px;
  border-radius: 6px;
  border: none;
  margin-top: 3px;
}

textarea {
  resize: vertical;
}

button {
  margin-top: 12px;
  padding: 10px;
  width: 100%;
  background: #52b788;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  cursor: pointer;
}

button.borrar { background: #9b2226; }

table {
  width: 100%;
  margin-top: 15px;
  border-collapse: collapse;
  font-size: 11px;
}

th, td {
  border: 1px solid #40916c;
  padding: 4px;
}

#mensajeEstado {
  margin-top: 12px;
  padding: 10px;
  border-radius: 8px;
  background: rgba(0,0,0,0.3);
  text-align: left;
}
</style>
</head>

<body>

<h1>üå± Sala de Cultivo Inteligente</h1>

<div class="baldes" id="baldes"></div>

<div id="panel" class="panel oculto">
  <h2 id="tituloBalde"></h2>

  <div id="mensajeEstado"></div>

  <label>Gen√©tica</label>
  <input id="genetica">

  <label>Etapa de la planta</label>
  <select id="etapa">
    <option value="">Sin definir</option>
    <option>Germinaci√≥n</option>
    <option>Vegetativo</option>
    <option>Floraci√≥n</option>
    <option>Lavado</option>
  </select>

  <label>üì∏ Foto de la planta</label>
  <input type="file" id="fotoBalde" accept="image/*">

  <form id="registroForm">
    <label>Semana</label>
    <input type="week" id="semana" required>

    <label>pH</label>
    <input type="number" step="0.1" id="ph">

    <label>EC</label>
    <input type="number" step="0.1" id="ec">

    <label>Grow</label>
    <input type="number" step="0.1" id="grow">

    <label>Micro</label>
    <input type="number" step="0.1" id="micro">

    <label>Bloom</label>
    <input type="number" step="0.1" id="bloom">

    <label>üìù Nota semanal</label>
    <textarea id="nota"></textarea>

    <label>üì∑ Foto semanal</label>
    <input type="file" id="fotoSemana" accept="image/*">

    <button>üíæ Guardar registro semanal</button>
  </form>

  <div id="historial"></div>

  <button class="borrar" id="borrarHistorial">üóëÔ∏è Cerrar ciclo</button>
</div>

<script>
const baldesDiv = document.getElementById("baldes");
const panel = document.getElementById("panel");
const tituloBalde = document.getElementById("tituloBalde");
const mensajeEstado = document.getElementById("mensajeEstado");

const genetica = document.getElementById("genetica");
const etapa = document.getElementById("etapa");
const fotoBalde = document.getElementById("fotoBalde");

const registroForm = document.getElementById("registroForm");
const semana = document.getElementById("semana");
const ph = document.getElementById("ph");
const ec = document.getElementById("ec");
const grow = document.getElementById("grow");
const micro = document.getElementById("micro");
const bloom = document.getElementById("bloom");
const nota = document.getElementById("nota");
const fotoSemana = document.getElementById("fotoSemana");
const historial = document.getElementById("historial");

let baldeActual = null;

/* ===== BALDES ===== */
for (let i = 1; i <= 9; i++) {
  const b = document.createElement("div");
  b.id = `balde${i}`;
  b.className = "balde";
  b.onclick = () => abrirBalde(i);
  baldesDiv.appendChild(b);
  actualizarBalde(i);
}

function evaluarEstado(ph, ec) {
  let estado = "ok";
  let mensajes = [];

  if (ph < 5.5 || ph > 6.5) {
    estado = "mal";
    mensajes.push("pH fuera de rango cr√≠tico.");
  } else if (ph < 5.8 || ph > 6.2) {
    estado = "at";
    mensajes.push("pH no √≥ptimo.");
  }

  if (ec < 1) mensajes.push("EC baja, agregar nutrientes.");
  if (ec > 2.5) {
    estado = "mal";
    mensajes.push("EC muy alta, diluir soluci√≥n.");
  }

  if (!mensajes.length) mensajes.push("Par√°metros √≥ptimos.");

  return { estado, mensajes };
}

function actualizarBalde(n) {
  const g = localStorage.getItem(`balde${n}_genetica`) || "Sin gen√©tica";
  const e = localStorage.getItem(`balde${n}_estado`) || "ok";
  const foto = localStorage.getItem(`balde${n}_foto`);

  const b = document.getElementById(`balde${n}`);
  b.className = `balde estado-${e}`;
  b.innerHTML = `<span>ü™£ Balde ${n}<br><small>${g}</small></span>`;
  b.style.backgroundImage = foto ? `url(${foto})` : "none";
}

function abrirBalde(n) {
  baldeActual = n;
  panel.classList.remove("oculto");

  genetica.value = localStorage.getItem(`balde${n}_genetica`) || "";
  etapa.value = localStorage.getItem(`balde${n}_etapa`) || "";

  tituloBalde.innerText = `Balde ${n}`;
  cargarHistorial();
}

genetica.onchange = () => {
  localStorage.setItem(`balde${baldeActual}_genetica`, genetica.value);
  actualizarBalde(baldeActual);
};

etapa.onchange = () => {
  localStorage.setItem(`balde${baldeActual}_etapa`, etapa.value);
};

fotoBalde.onchange = e => {
  const reader = new FileReader();
  reader.onload = () => {
    localStorage.setItem(`balde${baldeActual}_foto`, reader.result);
    actualizarBalde(baldeActual);
  };
  reader.readAsDataURL(e.target.files[0]);
};

registroForm.onsubmit = e => {
  e.preventDefault();

  const evaluacion = evaluarEstado(ph.value, ec.value);

  const data = {
    semana: semana.value,
    ph: ph.value,
    ec: ec.value,
    grow: grow.value,
    micro: micro.value,
    bloom: bloom.value,
    nota: nota.value,
    estado: evaluacion.estado,
    mensajes: evaluacion.mensajes
  };

  localStorage.setItem(`balde${baldeActual}_${semana.value}`, JSON.stringify(data));
  localStorage.setItem(`balde${baldeActual}_estado`, evaluacion.estado);

  registroForm.reset();
  cargarHistorial();
  actualizarBalde(baldeActual);
};

function cargarHistorial() {
  const keys = Object.keys(localStorage)
    .filter(k => k.startsWith(`balde${baldeActual}_`) && /\d{4}-W\d{2}/.test(k))
    .sort();

  let html = `
  <table>
    <tr>
      <th>Semana</th>
      <th>pH</th>
      <th>EC</th>
      <th>Grow</th>
      <th>Micro</th>
      <th>Bloom</th>
      <th>Nota</th>
      <th>Estado</th>
    </tr>`;

  let ultimo = null;

  keys.forEach(k => {
    const d = JSON.parse(localStorage[k]);
    ultimo = d;
    html += `
    <tr>
      <td>${d.semana}</td>
      <td>${d.ph}</td>
      <td>${d.ec}</td>
      <td>${d.grow}</td>
      <td>${d.micro}</td>
      <td>${d.bloom}</td>
      <td>${d.nota || ""}</td>
      <td>${d.estado}</td>
    </tr>`;
  });

  historial.innerHTML = html + "</table>";

  if (ultimo) {
    mensajeEstado.innerHTML =
      `<strong>Estado actual:</strong>
       <ul>${ultimo.mensajes.map(m => `<li>${m}</li>`).join("")}</ul>`;
  }
}

document.getElementById("borrarHistorial").onclick = () => {
  if (!confirm("¬øCerrar ciclo completo?")) return;
  Object.keys(localStorage)
    .filter(k => k.startsWith(`balde${baldeActual}_`))
    .forEach(k => localStorage.removeItem(k));

  historial.innerHTML = "";
  mensajeEstado.innerHTML = "";
  actualizarBalde(baldeActual);
};
</script>

<!-- REGISTRO SERVICE WORKER -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
